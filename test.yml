---
- name: 'Test Plone'
  hosts:
    - localhost
  connection: 'local'
  vars:
    plone_base_port: 8080
    plone_workers: 2
  tasks:

    - name: 'Rewrite the supervisord socket to avoid path too long error on github actions'
      ansible.builtin.replace:
        path: 'etc/supervisord.conf'
        regexp: '^file = .*$'
        replace: 'file = var/supervisord.sock'

    - name: 'Check if the instances are running'
      ansible.builtin.uri:
        url: 'http://localhost:{{ plone_instance_port }}/@@ok'
        status_code: 200
      loop: '{{ range(plone_workers) | list }}'
      loop_control:
        loop_var: 'plone_instance_number'
      vars:
        plone_instance_port: '{{ plone_base_port | int + plone_instance_number | int + 1 }}'
